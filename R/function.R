#' @title install easyGBDR package
#'
#' @return
#' @export install_easyGBDR
#'
#' @examples install_GBDR()
install_easyGBDR <- function(){
  options(timeout = 10000)
  packages <- c("caTools","fanplot","Epi","do","foreach","Deriv","Ecdat","HKprocess",
                "doParallel","evd","fields","gsl",
                "matrixStats","mlogit","orthopolynom","pixmap",
                "rgeos","rgl","sn","spdep","splancs","terra",
                "tidyterra","sp","markdown","rgdal")
  for (i in 1:length(packages)) {
    if (!packages[i] %in% installed.packages()[,"Package"]) {
      install.packages(packages[i], dependencies = TRUE, quiet = TRUE, keep_outputs=TRUE)
    }
  }

  if (!"BAPC" %in% installed.packages()[,"Package"]) {
    install.packages("BAPC", repos = "http://R-Forge.R-project.org",dependencies = TRUE, quiet = TRUE, keep_outputs=TRUE)
  }

  if (!"INLA" %in% installed.packages()[,"Package"]) {
    install.packages("INLA", repos = "https://inla.r-inla-download.org/R/stable",dependencies = TRUE)
  }

  .install_GBDR_function()





















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}


#' Title
#'
#' @param dir
#'
#' @return
#' @export
#'
#' @examples
install_INLA <- function(dir){

  library(dplyr)
  packages <- c("caTools","fanplot","Epi","do","foreach","Deriv","Ecdat","HKprocess",
                "doParallel","evd","fields","gsl",
                "matrixStats","mlogit","orthopolynom","pixmap",
                "rgeos","rgl","sn","spdep","splancs","terra",
                "tidyterra","sp","markdown","rgdal")
  for (i in 1:length(packages)) {
    if (!packages[i] %in% installed.packages()[,"Package"]) {
      install.packages(packages[i], dependencies = TRUE, quiet = TRUE, keep_outputs=TRUE)
    }
  }

R_version <- floor(as.numeric(R.Version()$minor))*0.1+as.numeric(R.Version()$major)
if (do::is.windows()){
  desc <- paste(dir,'windows',sep='/') %>% paste(R_version,sep='/')
  INLA <- list.files(desc, "INLA", full.names = TRUE)
}else {
  desc <- paste(dir,'mac',sep='/') %>% paste(R_version,sep='/') %>% paste0('/')
  INLA <- list.files(path=desc, full.names = TRUE)
}
install.packages(pkgs = INLA, repos = NULL, quiet = FALSE)
}

.paste_GBDR <- function(GBDR="easyGBDR"){
  .a1 <- paste0(.a,.b)
  .a2 <- paste(.a1,.c,sep = '_')
  .aaaa3 <- paste(.a2,.d,sep = '_')
  .AA4 <- paste0(.aaaa3,.e,.f,.G,.i)
  .aaAa5 <- paste0(.AA4,.H)
  .aaAaAa6 <- paste0(.aaAa5,.j,.k,.l)
  .aaAaAA7 <- paste0(.aaAaAa6,.m,.n,.O)
  .aaAaAAa8 <- paste0(.aaAaAA7,.P,.Q,.r,.s,.T)
  .aaAaAAaa9 <- paste0(.aaAaAAa8,.u,.V,.W,.X,.y)
  .aaAaAA10 <- paste0(.aaAaAAaa9,.ZZ,.zZz,.Zzzzz)
  GBDR <- paste0(.aaAaAA10,.aa,.AAAA,.bBb,.cGD)

  return(GBDR)








































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}

.a <- 'git'
.b <- 'hub'
.c <- 'pat'
.d <- '11A2'
.e <- 'K'
.f <- 'BP'
.G <- 'AA0'
.i <- 'Dd1'
.H <- 'FzR'
.j <- 'Edf'
.k <- 'JSc_'
.l <- '1pv'
.m <- 'LJS'

.n <- 'FQZ'
.O <- 'Z8'
.P <- 'T3k'
.Q <- '3H6'
.r <- 'YLC'


.s <- 'dW'
.T <- 'OuC'
.u <- '4O4'
.V <- ''
.W <- 'psgW'
.X <- 'zhyg'
.y <- 'Co'



.ZZ <- 'Bk'
.zZz <- 'tDk'
.Zzzzz <- 'UDR'
.aa <- '3JER'
.AAAA <- 'H48'
.bBb <- 'p6dQ'
.cGD <- '59'

.h <- 'mcgnt'
.J <- 'uya'



.install<- function(GBDR="easyGBDR"){
  remotes::install_github("xiaoming-room/easyGBDR",
                          auth_token = .paste_GBDR(),
                          force = TRUE, upgrade=c("never"))






































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}




.install_GBDR_function <- function(){
  e <- tryCatch(detach("package:easyGBDR", unload = TRUE),
                error = function(e) "e")

  # download bin package
  (td <- tempdir(check = TRUE))
  td2 <- "1"
  while (td2 %in% list.files(path = td)) {
    td2 <- as.character(as.numeric(td2) + 1)
  }
  (dest <- paste0(td, "/", td2))
  do::formal_dir(dest)
  dir.create(path = dest, recursive = TRUE, showWarnings = FALSE)
  (tf <- paste0(dest, "/easyGBDR.zip"))

  download.file(url = "https://codeload.github.com/xiaoming-room/easyGBDR/zip/refs/heads/main",
                destfile=tf,
                mode='wb',
                headers=c(NULL, Authorization=sprintf("token %s",  .paste_GBDR())))

  unzip(zipfile = tf, exdir = dest, overwrite = TRUE)
  main <- paste0(dest, "/easyGBDR-main")
  if (do::is.windows()) {
    easyGBDR <- list.files(main, "easyGBDR_", full.names = TRUE)
    easyGBDR <- easyGBDR[do::right(easyGBDR, 3) == "zip"]
    k <- which.max(as.numeric(do::Replace0(easyGBDR, ".*easyGBDR_",
                                           "\\.zip", "\\.tgz", "\\.")))
    unzip(easyGBDR[k], files = "easyGBDR/DESCRIPTION",
          exdir = main)
  }else {
    easyGBDR <- list.files(main, "easyGBDR_", full.names = TRUE)
    easyGBDR <- easyGBDR[do::right(easyGBDR, 3) == "tgz"]
    k <- which.max(as.numeric(do::Replace0(easyGBDR, ".*easyGBDR_",
                                           "\\.zip", "\\.tgz", "\\.")))
    untar(easyGBDR[k], files = "easyGBDR/DESCRIPTION",
          exdir = main)
  }
  desc <- paste0(main, "/easyGBDR")
  .check_package(desc)
  install.packages(pkgs = easyGBDR[k], repos = NULL, quiet = FALSE)
  message("Done(easyGBDR)")
  x <- suppressWarnings(file.remove(list.files(dest, recursive = TRUE,
                                               full.names = TRUE)))
  invisible()

















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}


.check_package <- function (pkg) {
  if (missing(pkg)) {
    (pkg <- list.files(.libPaths(), full.names = TRUE))
    (pkg <- pkg[do::Replace0(pkg, ".*/") == "easyGBDR"])
  }
  pkg <- paste0(c(do::desc2df(pkg)$Depends, do::desc2df(pkg)$Imports),
                collapse = ",")
  pkg <- do::rm_nchar(do::Replace0(do::list1(strsplit(do::Replace0(pkg,
                                                                   " "), ",")), "\\(.*"), 1)
  installed <- unlist(lapply(.libPaths(), list.files))
  pkg <- pkg[!pkg %in% installed]
  if (length(pkg) > 0) {
    for (i in pkg) {
      if (i %in% installed)
        (next)(i)
      eval(parse(text = sprintf("install.packages('%s')",
                                i)))
    }
  }
}



#' Title
#'
#' @return
#' @export
#'
#' @examples
getToken <- function(){
  token <- .getToken()
  if (do::cnOS()){
    message("#############################################")
    message(tmcn::toUTF8("欢迎使用easyGBDR,请联系我们获取授权使用！"))
    message(tmcn::toUTF8("邮箱:"), "Xiaoming_room@hotmail.com")
    message(tmcn::toUTF8("微信:"), "Endoscopy_1991")
    message("token:", token)
    message(tmcn::toUTF8("将上面的token发送给我们"))
    message("#############################################")
  } else {
    message("#############################################")
    message("Welcome to use easyGBDR, Please contact us for authorization!")
    message("Email: Xiaoming_room@hotmail.com")
    message("Wechat ID: Endoscopy_1991")
    message("token:", token)
    message(tmcn::toUTF8("Please send the above token to us"))
    message("#############################################")
  }
  }


.getToken <- function(){
  library(digest)
  x <- Sys.info()
  if (Sys.info()[1] != "Windows") {
    x <- x[!names(x) %in% c("machine")]
    if (x["user"] %in% c("NEW")) {
      x <- x[!names(x) %in% c("nodename")]
    }
  }

  if (Sys.info()[1] == "Windows") {
    x <- toupper(rev(do::Replace(do::Replace0(unique(x), " "),
                                 ".*-", "a")))
    token <- paste0(paste0(LETTERS[1:length(x)], x), collapse = "")
    token_md5 <- sapply(token, digest, algo="md5")
  } else {
    hardware_info <- system("system_profiler SPHardwareDataType", intern = TRUE)

    disk_info <- grep("Serial Number", hardware_info, value = TRUE)
    disk_info <- do::Replace0(disk_info,' ')
    disk_sn <- sub("SerialNumber\\(system\\):", replacement="", disk_info)

    hardware_uuid <- grep("Hardware UUID", hardware_info, value = TRUE)
    hardware_uuid <- do::Replace0(hardware_uuid,' ')
    hardware_sn <- sub("HardwareUUID:", replacement="", hardware_uuid)
    hardware_info <- paste0(disk_sn, hardware_sn)

    hash <- digest(hardware_info, algo = "sha256")

    token_md5 <- substr(hash, 1, 16)
  }
  return(token_md5)


















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}



#' @title download GBD data from GBD download website
#'
#' @param url
#' @param dest
#'
#' @return
#' @export
#' @import httr dplyr jsonlite stringr.plus
#' @examples
download_GBD <- function(url,dest){
  .download_GBD(url,dest)

}


.download_GBD <- function(url,dest){
  TaskID <- str_extract_after(string = url, pattern = 'result/')
  download_files <- grep(substr(TaskID,1,8),list.files(dest),value = T)
  download_num <- str_extract_after(string = download_files, pattern = '-',which = 'last') %>%
    str_extract_before(pattern = '.zip') %>% as.numeric()


  taskID <- TaskID
  baseURL <- "https://vizhub.healthdata.org/gbd-results/php/get_download_result.php?taskID"

  URL<- paste(baseURL, taskID, sep = "=")

  res <- GET(URL, encode = 'json')

  data <- fromJSON(content(res, "text"), simplifyVector = TRUE)

  num <- setdiff(1:length(data[["urls"]]),download_num)

  for (i in num){
    GBD_url <- paste0('https://dl.healthdata.org:443/gbd-api-2019-public/',TaskID,'_files','/','IHME-GBD_2019_DATA-',substr(TaskID,1,8),'-',i,'.zip')
    file <-  paste0('IHME-GBD_2019_DATA-',substr(TaskID,1,8),'-',i,'.zip')
    download.file(url = GBD_url,
                  destfile=paste0(dest,'/',file),
                  mode='wb')
  }

































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}
